<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L'Harmonie üåô</title>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBPNfMyhIOTWyGG-ZB5pOTr-y3TA0J3B28",
            authDomain: "mon-projet062.firebaseapp.com",
            databaseURL: "https://mon-projet062-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "mon-projet062",
            storageBucket: "mon-projet062.appspot.com",
            messagingSenderId: "1054174163421",
            appId: "1:1054174163421:web:50817b3c930a5eb55ac634"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap');

        :root {
            --accent: #9b5de5;
            --accent-light: #f178ff;
            --bg: #0d0617;
            --card-bg: rgba(255, 255, 255, 0.05);
            --text-color: #e0e0e0;
        }

        body, html {
            margin: 0; padding: 0; min-height: 100vh;
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg);
            color: var(--text-color); overflow-x: hidden;
            scroll-behavior: smooth;
        }

        /* --- FOND ANIME NEBULA --- */
        .nebula {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 50%, #2d1b4e 0%, #0d0617 100%);
            z-index: -2;
        }
        .nebula::after {
            content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: transparent url('https://www.transparenttextures.com/patterns/stardust.png') repeat;
            animation: move-stars 100s linear infinite; opacity: 0.3;
        }
        @keyframes move-stars { from { transform: translate(0,0); } to { transform: translate(100px, 100px); } }

        /* --- ECRAN D'ENTR√âE --- */
        #intro-screen {
            position: fixed; inset: 0; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: var(--bg); padding: 20px; text-align: center;
            transition: all 1s cubic-bezier(0.645, 0.045, 0.355, 1);
        }
        
        #intro-screen.fade-out {
            opacity: 0; pointer-events: none; transform: scale(1.5) rotate(2deg); filter: blur(20px);
        }

        .welcome-title {
            font-size: clamp(2.5rem, 8vw, 4rem); font-weight: 800;
            background: linear-gradient(to right, #fff, var(--accent-light));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 10px; animation: pulseGlow 3s infinite;
        }
        @keyframes pulseGlow {
            0%, 100% { text-shadow: 0 0 10px rgba(155, 93, 229, 0.2); }
            50% { text-shadow: 0 0 20px rgba(155, 93, 229, 0.6); }
        }

        .rules-card {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
            padding: 25px; border-radius: 20px; max-width: 400px; margin-bottom: 30px;
            backdrop-filter: blur(10px); color: var(--text-color);
        }

        .neon-btn {
            background: var(--accent); color: white; border: none;
            padding: 18px 50px; border-radius: 50px; font-weight: 700;
            font-size: 1.1rem; cursor: pointer; transition: 0.4s;
            box-shadow: 0 10px 30px rgba(155, 93, 229, 0.4);
        }
        .neon-btn:hover { transform: translateY(-5px); box-shadow: 0 15px 40px var(--accent); }

        /* --- GAME D'INTRODUCTION (PULSATION) --- */
        #pulsation-game {
            display: none; /* Initialement cach√© */
            margin-top: 30px;
            background: rgba(255,255,255,0.05); border-radius: 15px; padding: 20px;
            border: 1px solid var(--accent); max-width: 450px; width: 100%;
            box-shadow: 0 0 20px rgba(155, 93, 229, 0.3);
        }
        .pulse-circle {
            width: 80px; height: 80px; background: var(--accent-light); border-radius: 50%;
            margin: 20px auto; animation: pulseBeat 1s infinite alternate;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 2rem; box-shadow: 0 0 25px var(--accent-light);
        }
        .pulse-circle.active { animation: none; transform: scale(0.9); box-shadow: 0 0 10px var(--accent); }
        .pulse-circle.correct { background: #4caf50; box-shadow: 0 0 25px #4caf50; }
        .pulse-circle.wrong { background: #f44336; box-shadow: 0 0 25px #f44336; }

        @keyframes pulseBeat {
            from { transform: scale(0.9); opacity: 0.8; }
            to { transform: scale(1.1); opacity: 1; }
        }
        #pulse-text { font-size: 1.1rem; margin-bottom: 15px; color: var(--accent-light); }
        #pulse-score { font-size: 0.9rem; opacity: 0.7; }

        /* --- CONTENU PRINCIPAL (L'Harmonie) --- */
        #main-content { opacity: 0; transition: 1.5s; }
        #main-content.visible { opacity: 1; }

        header { padding: 40px 20px 20px; text-align: center; }
        
        .xp-container { 
            width: clamp(200px, 50%, 400px); height: 8px; 
            background: rgba(255,255,255,0.1); border-radius: 10px; 
            margin: 20px auto; overflow: hidden; border: 1px solid rgba(255,255,255,0.05);
        }
        #xp-fill { width: 0%; height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-light)); transition: 1.2s ease; }

        .main-container {
            max-width: 1200px; margin: auto; padding: 20px;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 30px;
        }

        .card {
            background: var(--card-bg); backdrop-filter: blur(20px);
            border-radius: 35px; padding: 30px; border: 1px solid rgba(255,255,255,0.08);
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .card:hover { transform: translateY(-10px); border-color: var(--accent); }

        .section-separator {
            font-size: 0.75rem; text-transform: uppercase; opacity: 0.4; letter-spacing: 1.5px;
            display: flex; align-items: center; justify-content: center; gap: 10px; margin: 30px 0 15px;
            color: var(--accent-light);
        }
        .section-separator::before, .section-separator::after {
            content: ''; flex-grow: 1; height: 1px; background: rgba(255,255,255,0.1);
        }

        textarea {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 18px; color: var(--text-color); padding: 15px; margin-bottom: 12px;
            font-family: inherit; resize: none; box-sizing: border-box; transition: 0.3s;
        }
        textarea:focus { border-color: var(--accent-light); background: rgba(0,0,0,0.5); outline: none; }

        .status-dot { width: 12px; height: 12px; background: #333; border-radius: 50%; display: inline-block; margin-left: 10px; }
        .status-dot.active { background: #00ff88; box-shadow: 0 0 15px #00ff88; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .finish-btn {
            width: 100%; padding: 18px; border-radius: 20px; border: none;
            background: linear-gradient(45deg, var(--accent), #7037b3);
            color: white; font-weight: 700; cursor: pointer; transition: 0.3s;
            box-shadow: 0 5px 20px rgba(155, 93, 229, 0.3);
        }
        .finish-btn:active { transform: scale(0.98); box-shadow: 0 2px 10px rgba(155, 93, 229, 0.5); }
        .finish-btn.completed { background: linear-gradient(45deg, #4CAF50, #2E7D32); }

        #timer { font-weight: 600; font-size: 0.9rem; opacity: 0.8; letter-spacing: 1px; }

    </style>
</head>
<body>

    <div class="nebula"></div>

    <div id="intro-screen">
        <div class="animate__animated animate__fadeInDown">
            <h1 class="welcome-title">L'Harmonie</h1>
            <div class="rules-card">
                <p style="margin: 0; line-height: 1.6;">
                    ‚ú® <b>Bienveillance</b>, fondement de notre lien.<br>
                    ‚ú® <b>Honn√™tet√©</b>, reflet de nos √¢mes.<br>
                    ‚ú® <b>√âcoute</b>, pour un c≈ìur √† c≈ìur sinc√®re.<br>
                    <small style="display:block; margin-top:15px; opacity:0.6;">Vos confidences s'√©vanouissent √† minuit.</small>
                </p>
            </div>
            <button id="startGameBtn" class="neon-btn" onclick="showPulsationGame()">Commencer l'Harmonie üíñ</button>

            <div id="pulsation-game" style="display: none;" class="animate__animated animate__zoomIn">
                <p id="pulse-text">Synchronisez vos c≈ìurs : cliquez en rythme sur le cercle qui pulse !</p>
                <div id="pulseCircle" class="pulse-circle" onclick="clickPulse()">‚ù§Ô∏è</div>
                <p id="pulse-score">Score : 0 / 5</p>
                <button id="validateGameBtn" class="neon-btn" style="margin-top:20px; display:none;" onclick="validatePulsationGame()">Valider et Entrer</button>
            </div>
        </div>
    </div>

    <div id="main-content">
        <header>
            <div id="timer">Connexion...</div>
            <div class="xp-container"><div id="xp-fill"></div></div>
        </header>

        <div class="main-container">
            <div class="card animate__animated animate__fadeInLeft">
                <h2 style="margin:0">Rayan <div id="dotRayan" class="status-dot"></div></h2>
                
                <div class="section-separator">Question du Jour</div>
                <div style="background:rgba(155, 93, 229, 0.1); padding:15px; border-radius:20px; margin:20px 0;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:0.7rem; opacity:0.5; text-transform:uppercase;">Votre pens√©e</span>
                        <button onclick="newQuestion()" style="background:none; border:none; cursor:pointer;">üé≤</button>
                    </div>
                    <p id="displayQ" style="margin:10px 0; color:var(--accent-light); font-weight:600;">...</p>
                    <textarea id="rQ" placeholder="Exprime ta r√©ponse √† la question ici..."></textarea>
                </div>

                <div class="section-separator">Journal Intime</div>
                <textarea id="r1" placeholder="Aujourd‚Äôhui j‚Äôai gard√© pour moi‚Ä¶"></textarea>
                <textarea id="r2" placeholder="Aujourd‚Äôhui j‚Äôai √©t√© fier(e) de‚Ä¶"></textarea>
                <textarea id="r3" placeholder="Aujourd‚Äôhui j‚Äôaurais aim√© te dire‚Ä¶"></textarea>
                <textarea id="r4" placeholder="Un truc qui m‚Äôa saoul√© / bless√©‚Ä¶"></textarea>
                <textarea id="r5" placeholder="Aujourd‚Äôhui j‚Äôai manqu√© de‚Ä¶"></textarea>
                
                <button id="btnRayan" class="finish-btn" onclick="complete('Rayan')">J'ai termin√© üñ§</button>
            </div>

            <div class="card animate__animated animate__fadeInRight">
                <h2 style="margin:0">Israh <div id="dotIsrah" class="status-dot"></div></h2>
                
                <div class="section-separator">Question du Jour</div>
                <div style="background:rgba(155, 93, 229, 0.1); padding:15px; border-radius:20px; margin:20px 0;">
                    <span style="font-size:0.7rem; opacity:0.5; text-transform:uppercase;">Votre pens√©e</span>
                    <p id="displayQIsrah" style="margin:10px 0; color:var(--accent-light); font-weight:600;">...</p>
                    <textarea id="iQ" placeholder="Exprime ta r√©ponse √† la question ici..."></textarea>
                </div>

                <div class="section-separator">Journal Intime</div>
                <textarea id="i1" placeholder="Aujourd‚Äôhui j‚Äôai gard√© pour moi‚Ä¶"></textarea>
                <textarea id="i2" placeholder="Aujourd‚Äôhui j‚Äôai √©t√© fier(e) de‚Ä¶"></textarea>
                <textarea id="i3" placeholder="Aujourd‚Äôhui j‚Äôaurais aim√© te dire‚Ä¶"></textarea>
                <textarea id="i4" placeholder="Un truc qui m‚Äôa saoul√© / bless√©‚Ä¶"></textarea>
                <textarea id="i5" placeholder="Aujourd‚Äôhui j‚Äôai manqu√© de‚Ä¶"></textarea>
                
                <button id="btnIsrah" class="finish-btn" style="background:linear-gradient(45deg, #f178ff, #9b5de5);" onclick="complete('Israh')">J'ai termin√© üñ§</button>
            </div>
        </div>
    </div>

<script>
    const questions = ["Le moment le plus dr√¥le de ta journ√©e ? üòÇ", "Si ta journ√©e √©tait un film, son titre ? üé¨", "R√©sume ta journ√©e en 3 mots absurdes üòú", "Un d√©tail nul mais marrant avec le recul ü§™", "Un truc que tu as aim√© chez l‚Äôautre aujourd'hui üíñ", "Si ta journ√©e √©tait un animal, lequel ? üê∂", "Un moment o√π tu t'es senti fier(e) üí™", "Un petit d√©fi ridicule que tu as r√©ussi üòè", "Un moment qui t‚Äôa fait sourire pour rien üòÑ", "Si tu pouvais rejouer 1 moment, lequel ? ‚ú®"];

    let finishedStatus = { Rayan: false, Israh: false };
    const textareasRayan = ['r1', 'r2', 'r3', 'r4', 'r5', 'rQ'];
    const textareasIsrah = ['i1', 'i2', 'i3', 'i4', 'i5', 'iQ'];

    // --- JEU D'INTRODUCTION PULSATION ---
    let pulseGameScore = 0;
    let lastClickTime = 0;
    let expectedClickTime = 0;
    let gameActive = false;
    let pulseInterval;

    function showPulsationGame() {
        document.getElementById('startGameBtn').style.display = 'none';
        document.getElementById('pulsation-game').style.display = 'block';
        gameActive = true;
        pulseGameScore = 0;
        document.getElementById('pulse-score').innerText = `Score : ${pulseGameScore} / 5`;
        startPulsation();
    }

    function startPulsation() {
        if (!gameActive) return;
        document.getElementById('pulseCircle').classList.remove('correct', 'wrong');
        expectedClickTime = Date.now();
        document.getElementById('pulseCircle').style.animationPlayState = 'running';
        pulseInterval = setTimeout(() => {
            if (gameActive) { // If user didn't click
                document.getElementById('pulseCircle').classList.add('wrong');
                pulseGameScore = Math.max(0, pulseGameScore - 1); // Penalize
                document.getElementById('pulse-score').innerText = `Score : ${pulseGameScore} / 5`;
                if (pulseGameScore < 5) startPulsation();
            }
        }, 800); // Give user 0.8s to click
    }

    function clickPulse() {
        if (!gameActive) return;
        clearTimeout(pulseInterval);
        const clickTime = Date.now();
        const diff = Math.abs(clickTime - expectedClickTime);
        document.getElementById('pulseCircle').classList.add('active'); // Visually indicate click

        if (diff < 300) { // If click is within 300ms of expected beat
            document.getElementById('pulseCircle').classList.add('correct');
            pulseGameScore++;
        } else {
            document.getElementById('pulseCircle').classList.add('wrong');
            pulseGameScore = Math.max(0, pulseGameScore - 1); // Penalize
        }
        document.getElementById('pulse-score').innerText = `Score : ${pulseGameScore} / 5`;

        if (pulseGameScore >= 5) {
            gameActive = false;
            document.getElementById('pulse-text').innerText = "C≈ìurs synchronis√©s ! ‚ú®";
            document.getElementById('validateGameBtn').style.display = 'block';
            document.getElementById('pulseCircle').style.animationPlayState = 'paused';
            document.getElementById('pulseCircle').classList.remove('correct', 'wrong', 'active');
            document.getElementById('pulseCircle').classList.add('correct'); // Final visual cue
        } else {
            setTimeout(() => { // Next pulse after a short delay
                document.getElementById('pulseCircle').classList.remove('active', 'correct', 'wrong');
                startPulsation();
            }, 500);
        }
    }

    function validatePulsationGame() {
        document.getElementById('intro-screen').classList.add('fade-out');
        document.getElementById('main-content').classList.add('visible');
        setTimeout(() => document.getElementById('intro-screen').style.display = 'none', 1000);
        newQuestion(); // Generate first question after game
    }
    // --- FIN JEU PULSATION ---

    window.onload = () => {
        database.ref('harmonie_v2').on('value', (snapshot) => {
            const data = snapshot.val();
            if(data) {
                if(data.rayan) {
                    textareasRayan.forEach((id, index) => {
                        const el = document.getElementById(id);
                        if(el && document.activeElement !== el) el.value = data.rayan[index] || "";
                    });
                }
                if(data.israh) {
                    textareasIsrah.forEach((id, index) => {
                        const el = document.getElementById(id);
                        if(el && document.activeElement !== el) el.value = data.israh[index] || "";
                    });
                }
                document.getElementById('displayQ').innerText = data.question || "Cliquez sur le d√© pour une question...";
                document.getElementById('displayQIsrah').innerText = data.question || "Cliquez sur le d√© pour une question...";
                
                finishedStatus = data.finished || {Rayan:false, Israh:false};
                if(finishedStatus.Rayan) document.getElementById('dotRayan').classList.add('active');
                if(finishedStatus.Israh) document.getElementById('dotIsrah').classList.add('active');

                // Update finish button style
                if (finishedStatus.Rayan) document.getElementById('btnRayan').classList.add('completed');
                if (finishedStatus.Israh) document.getElementById('btnIsrah').classList.add('completed');

                updateXP();
            } else {
                // If no data, set a default question
                 newQuestion(); // Call newQuestion to set an initial question
            }
        });
    };

    function newQuestion() {
        const q = questions[Math.floor(Math.random()*questions.length)];
        database.ref('harmonie_v2/question').set(q);
    }

    function save() {
        const data = {
            rayan: textareasRayan.map(id => document.getElementById(id).value),
            israh: textareasIsrah.map(id => document.getElementById(id).value),
            question: document.getElementById('displayQ').innerText,
            finished: finishedStatus
        };
        database.ref('harmonie_v2').update(data);
        updateXP();
    }

    function complete(user) {
        finishedStatus[user] = true;
        save(); // Save the new finished status
        document.getElementById('dot' + user).classList.add('active');
        document.getElementById('btn' + user).classList.add('completed');
        
        if(finishedStatus.Rayan && finishedStatus.Israh) {
            confetti({ particleCount: 200, spread: 80, origin: { y: 0.6 }, colors: ['#9b5de5', '#f178ff'] });
        }
    }

    function updateXP() {
        const totalInputs = [...document.querySelectorAll('#main-content textarea')]; // All textareas in main content
        let filledInputs = 0;
        totalInputs.forEach(el => { if(el.value.length > 2) filledInputs++ });
        document.getElementById('xp-fill').style.width = (filledInputs / totalInputs.length) * 100 + "%";
    }

    document.querySelectorAll('#main-content textarea').forEach(t => t.addEventListener('input', save));

    // Timer Minuit
    setInterval(() => {
        const now = new Date();
        const diff = new Date().setHours(24,0,0,0) - now;
        const h = Math.floor(diff/3600000);
        const m = Math.floor((diff%3600000)/60000);
        const s = Math.floor((diff%60000)/1000);
        document.getElementById('timer').innerText = `üåô L'Harmonie s'estompe dans ${h}h ${m}m ${s}s`;
        if(diff <= 0) database.ref('harmonie_v2').remove();
    }, 1000);
</script>
</body>
</html>
